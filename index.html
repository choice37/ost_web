<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파일 다운로드~</title>
</head>
<body>
    <h1>파일 다운로드~</h1>
    
    <!-- category.txt 다운로드 버튼 -->
    <p><a href="category.txt" download="category.txt">category.txt 다운로드</a></p>
    
    <!-- pattern.txt 다운로드 버튼 -->
    <p><a href="pattern.txt" download="pattern.txt">pattern.txt 다운로드</a></p>

    <h1>파일을 GitHub에 업로드</h1>
    <input type="file" id="fileInput" />
    <button id="uploadButton">업로드</button> <!-- onclick 이벤트 제거 -->

    <h1>리포지토리 파일 목록</h1>
    <ul id="fileList"></ul>
    <button onclick="deleteSelectedFiles()">선택한 파일 삭제</button>

    <script>
        // 환경변수를 저장할 전역 변수
        let repoOwner, repoName, accessToken;

        // 환경변수를 가져오는 함수
        fetch('/.netlify/functions/getEnvVariables')  // Netlify Function 호출
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();  // JSON으로 응답받기
            })
            .then(data => {
                repoOwner = data.repoOwner;  // 함수에서 받은 값 할당
                repoName = data.repoName;
                accessToken = data.accessToken;

                // 가져온 값을 콘솔에 출력
                console.log(repoOwner, repoName, accessToken);
            })
            .catch(error => {
                console.error('Error fetching environment variables:', error);
            });

        // 파일 업로드 함수
        async function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                console.error('파일을 선택하세요.');
                return; // 파일이 없을 경우 조기 리턴
            }

            const fileName = file.name;
            const reader = new FileReader();
            reader.onload = async function(event) {
                const content = event.target.result.split(',')[1]; // base64 인코딩
                const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${fileName}`;
                console.log(url);

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                    },
                    body: JSON.stringify({
                        message: `Upload ${fileName}`,
                        content: content,
                    }),
                });

                if (response.ok) {
                    const jsonResponse = await response.json();
                    console.log('파일 업로드 성공:', jsonResponse);
                    fetchFileList(); // 파일 목록 갱신
                } else {
                    const errorResponse = await response.json();
                    console.error('파일 업로드 실패:', errorResponse);
                }
            };
            reader.readAsDataURL(file); // 파일을 base64로 읽기
        }

        // 파일 목록 가져오기
        async function fetchFileList() {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;
            console.log(url);
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${accessToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                },
            });

            if (response.ok) {
                const files = await response.json();
                displayFileList(files);
            } else {
                console.error('파일 목록을 가져오는 데 실패했습니다:', await response.json());
            }
        }

        // 파일 목록 표시
        function displayFileList(files) {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            files.forEach(file => {
                const listItem = document.createElement('li');
                const isDeletable = !['.gitignore', 'index.html', 'tts.py'].includes(file.name);
                
                listItem.innerHTML = `
                    <input type="checkbox" value="${file.path}" ${isDeletable ? '' : 'disabled'}>
                    <span class="${isDeletable ? '' : 'disabled'}">${file.name}</span>
                `;
                fileList.appendChild(listItem);
            });
        }

        // 선택한 파일 삭제
        async function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            for (const checkbox of checkboxes) {
                const filePath = checkbox.value;
                await deleteFile(filePath);
            }
            fetchFileList(); // 파일 목록 갱신
        }

        // 파일 삭제 함수
        async function deleteFile(filePath) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${accessToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                },
                body: JSON.stringify({
                    message: `Delete ${filePath}`,
                    sha: await getFileSHA(filePath), // SHA를 가져와야 합니다.
                }),
            });

            if (response.ok) {
                console.log(`${filePath}가 성공적으로 삭제되었습니다.`);
            } else {
                console.error('파일 삭제 실패:', await response.json());
            }
        }

        // 파일의 SHA를 가져오는 함수
        async function getFileSHA(filePath) {
            const url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${accessToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                },
            });

            if (response.ok) {
                const fileInfo = await response.json();
                return fileInfo.sha; // 파일의 SHA 반환
            } else {
                console.error('파일 SHA를 가져오는 데 실패했습니다:', await response.json());
            }
        }
    </script>
</body>
</html>
